<html>
<head>
<title>WHUMP</title>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" >
<style>
.btn {
	font-weight: bold;
	font-size: 10px;
	background-color:#077;
	color:white;
	padding-left: 6px;
	padding-right: 6px;
}
.btb {
	font-weight: bold;
	font-size: 16px;
	background-color:#077;
	color:white;
	padding-left: 9px;
	padding-right: 9px;
}
#nowb {
	padding-bottom:4px;
	padding-top:4px;
}
.tbar {
	background-color: #aaa;
	color:#444;
	font-size:12px;
	overflow-x: hidden;
	white-space: nowrap;
}
#thdr {
	background-color: black;
	color: white;
	text-align: center;
	padding: 4px;
	white-space: nowrap;
	overflow-x: hidden;
}
#thdr a {
	color: white;
}
#pcont { 
	background-color: #666;
	color: white;
	text-align: center;
	padding-bottom: 6px;
	padding-top: 2px;
}
#pctl {
	width: 100%;
}
#nowp {
	color: #aaf;
}
#lcont {
	float: left;
	width: 60%;
}
#rcont {
	float: right;
	width: 40%;
	background-color: black;
	color: white;
}
#fbox {
	font-size: 10px;
}
#foot {
	width: 100%;
	background-color:#ccc;
	color: black;
	text-align: right;
	white-space: nowrap;
	overflow-x: hidden;

}
#res {
	overflow-y: scroll;
	overflow-x: hidden;
	height: 85%;
	background-color:white;
	color:black;
	white-space: nowrap;
}
#pl {
	color: white;
	overflow-y: scroll;
	overflow-x: hidden;
	height: 85%;
	margin-left: 4px;
	white-space: nowrap;
}
#pl a {
	color: #3f3;
	font-weight: normal;
}
#vis {
	width: 100%;
	height: 85%;
	display:none;
}
</style>
<script>

// can be overriden
var db_fntitle = function(s) {  
	return s.replace( /(.*)[.][a-zA-Z0-9]+?$/,"$1");
},
pl_fntitle = function(s) {
	return s.replace(/(.*[/])?(.*)[.][a-zA-Z0-9]+?$/, "$2");
},
fntourl = function(s) { 
	return s.replace(/#/g,"%23");
},
g_ls_pre="l_",
g_filt_t=null, g_play=null, g_res=null,
g_db=[], g_db_lens=[],
g_pl=[], g_pl_x=0, g_pl_ipp=1,g_rep=2,
W=window,
g_v=0, g_vt=null, g_vt_req=0,g_vm=0,g_pln="",
getE=function(f){return document.getElementById(f)};

function hasS(f, l) {
	for (var i in l) if (f.toLowerCase().indexOf(l[i])<0) return 0;
	return 1;
}

function pPi(i,f) {
	g_play.src = fntourl(g_pl[g_pl_x=i]);
	g_play.load();
	f && g_play.play();
	updNowp();
}

function mkDiv(p,t) {
	var i = document.createElement("div");
	i.innerHTML = t;
	p.appendChild(i);
	return i;
}

function plUpd() {
        getE("phn").innerHTML = g_pl_ipp ? "<i> -- pre-populated favorites</i>" : "";

	var i=0, d=getE("pl"), n=d.childNodes, p=n.length, c=g_pl.length;
	for (;i<c;i++) {
		var a = g_pl[i], t = (i+1) + ". " +  pl_fntitle(a), url=fntourl(a);
		if (i>=p) mkDiv(d,"<span class=\"btn\" onClick=\"plRm(" + i + ")\">x</span> " +
				 "<a href=\"" + url + "\"  onClick=\"return seek(" + i + ")\">" + t + "</a><BR>");
		else {
			var v = n[i].childNodes[2];
			v.href = url;
			v.innerHTML = t;
		}
	}
	while (p > c) d.removeChild(n[--p]);
	updNowp();
}

function updNowp() {
	getE("nowp").innerHTML = 
		(g_pl_x >= 0 && g_pl_x < g_pl.length) ?
		(g_pl_x+1) + ". " + pl_fntitle(g_pl[g_pl_x]) : "ready";
}

function seek(i) {
	if (i >= 0 && i < g_pl.length) {
		if (g_pl_x != i || isStop()) pPi(i,1);
		else if (g_play.paused) g_play.play();
	}
	return false;
}

function isStop() {
	return g_play.ended || g_play.error;
}

function plClr() {
	g_pl = [];
	g_pl_x = 0;
	g_pl_ipp = 0;
	plUpd();
	g_play.pause();
}

function plSave() {
	var x,v = window.prompt("Save playlist?",g_pln), ls=window.localStorage;
	if (v==null) return;
	if (!g_pl.length) ls.removeItem(g_ls_pre+v);
	else ls.setItem(g_ls_pre+v,g_pl.join("\t"));
	g_pln=v;
}
function plLoad() {
	var p = "Load playlist? Available playlists:\n", x,ls=window.localStorage, n;
	for (x=0;x<ls.length;x++) {
		n = ls.key(x);
		if (n.substring(0,g_ls_pre.length) == g_ls_pre) p += "\t" + n.substring(g_ls_pre.length) + "\n";
	}
	p = window.prompt(p,g_pln);
	if (p==null) return;
	g_pln = p;
	p = ls.getItem(g_ls_pre + p);
	plClr();
	if (p!=null && p!="") {
		g_pl = p.split("\t");
		plUpd();
	}
}

function plSrt(m) {
	if (g_pl.length>1) {
		var fn=g_pl[g_pl_x],x;
		if (m==1) g_pl.reverse();
		else if (m==2) {
			for (x in g_pl) g_pl[x] = [g_pl[x],Math.random()];
			g_pl.sort(function(a,b){return a[1]-b[1];});
			for (x in g_pl) g_pl[x] = g_pl[x][0];
		}
		else g_pl.sort(function(a,b){
			return pl_fntitle(a).toLowerCase() > 
				pl_fntitle(b).toLowerCase() ? 1:-1;
		});
		g_pl_x=g_pl.indexOf(fn);
		g_pl_ipp = 0;
		plUpd();
	}
}

function plRm(i) {
	g_pl.splice(i,1);
	if (g_pl_x == i) g_pl_x < g_pl.length ? pPi(g_pl_x,!isStop() && !g_play.paused) : g_play.pause();
	else if (g_pl_x > i) g_pl_x--;
	g_pl_ipp = 0;
	plUpd();
}

function nq(idx, fst, up) {
	g_pl_ipp && fst == 1 && fst++;
	g_pl_ipp = 0;

	if (fst>1) { 
		g_pl=[];
		g_pl_x=0;
	}
	if (idx>=0 && idx < g_db.length) {
		var i=g_pl.length;
		g_pl[i] = g_db[idx];
		if (fst || !i || isStop() || g_play.paused) pPi(i,1);
  	}
	up && plUpd();
}

function fmtLen(x) {
	var s = g_db_lens[x], s2=(s%60);
	return s > 0 ? (Math.floor(s/60) + ":" + (s2 < 10 ? "0" : "") + s2) : "";
}

function dbFlt(cb) {
	var n,x, f = getE("fbox").value.toLowerCase().split(" ");
	for (x in g_db) {
                n = db_fntitle(g_db[x]);
		if (!f.length || hasS(n,f)) cb(n,x);
	}
}

function rnMk(x, lb) {
	return "<span class=\"btn\">play</span> " + "<span class=\"btn\">queue</span> " + "<span>" + lb + "</span>";
}
function rnCfg(n, x) {
	n=n.childNodes;
	n[0].onclick = function() { nq(x,1,1); };
	n[2].onclick = n[4].onclick = function() { nq(x,0,1); };
}

function genRes() {
	var c=0, n=g_res.childNodes, dl = n.length;
        dbFlt(function(nm, x) {
		var lb = nm + " <i>" + fmtLen(x) + "</i>", a, d;
		if (c < dl) {
			d = n[c++];
			a = d.childNodes;
			if (a.length == 5) a[4].innerHTML = lb;
			else d.innerHTML=rnMk(x,lb);
		} else d = mkDiv(g_res,rnMk(x,lb));
		rnCfg(d,x);
        });
	while (dl > c) g_res.removeChild(n[--dl]);
}

function pAll(c) {
        dbFlt(function(n, x) { nq(x,!c++,0); });
	plUpd();
}

function vis(c,cv) {
	var cnt=0, dl=512,
		bb = document.createElement("canvas"),
		da = new Uint8Array(dl),
		source = c.createMediaElementSource(g_play), 
		a=c.createAnalyser();

	a.fftSize=dl;
	source.connect(a);
	a.connect(c.destination);

	function v2h(i) { 
		return ((127*Math.sin(i*0.1)+0x180)|0).toString(16).substr(-2);
	};

        function f() {
		g_vt_req=0;
		if (!g_v || !a) return;

		var cw = cv.width, ch = cv.height, 
			ctx = cv.getContext("2d"),  
			sc=0.01*(1.2+Math.cos(cnt*0.03)) + 0.03,
			sc2=0.009*Math.cos(cnt*0.011), 
			sc3=0.004*Math.sin(cnt*0.018+1.2),
			xsc = cw / dl, x, yo = Math.sin(cnt*0.001)*ch*0.08;

		bb.width = cw;
		bb.height = ch;

		var bbc = bb.getContext("2d");

		if (g_vm&2) sc-=0.06;
		bbc.imageSmoothingEnabled=!(g_vm&1);

		bbc.drawImage(cv, 
			cw*(sc+sc2),ch*(sc+sc3), 
			cw*(1.0-2*sc),ch*(1.0-2*sc), 0,0,cw,ch);
		ctx.drawImage(bb, 0,0);

		ctx.strokeStyle="#" + v2h(cnt) + v2h(cnt*1.3) + v2h(cnt*0.76);
		ctx.beginPath();

		a.getByteTimeDomainData(da);
		for (x = 0; x < dl; x ++) {
			var y = ch*0.5 * (1.0 + (da[x]-0x80)*0.0078125) + yo;
			x ? ctx.lineTo(x*xsc,y) : ctx.moveTo(0,y);
		}
		ctx.stroke();
 
		cnt++;
		if (!g_vt_req++) window.requestAnimationFrame(f);
	}
	return f;
}

function visb() {
	g_v=!g_v;
	if (g_v && !g_vt) {
		var ac = window.AudioContext || window.webkitAudioContext;
		if (ac) {
			g_vt = vis(new ac, getE("vis"));
		}
	}
	if (g_v && g_vt) {
		getE("vis").style.display="inline";
		getE("lib").style.display="none";
		getE("visb").innerHTML = "lib";
		if (!g_vt_req++) window.requestAnimationFrame(g_vt);
	} else {
		getE("lib").style.display="inline";
		getE("vis").style.display="none";
		getE("visb").innerHTML = "vis";
	}

}

function repcl() {
	getE("rep").innerHTML = 
		"repeat " + (["off", "all", "one"])[g_rep = (g_rep+1)%3];
}

function onF() {
	if (g_filt_t != null) W.clearTimeout(g_filt_t);
	g_filt_t = W.setTimeout(function() { g_filt_t = null; genRes() }, 300);
}

function request_db(list) {
	var r=0;
/*@cc_on @*/
/*@if (@_jscript_version >= 5)
try { r = new ActiveXObject("Msxml2.XMLHTTP"); } catch (e) { try { r = new ActiveXObject("Microsoft.XMLHTTP"); } catch (E) { r = 0; } }
@end @*/
if (!r && typeof XMLHttpRequest!='undefined') { try { r = new XMLHttpRequest(); } catch (e) { r=0; } }
if (!r && W.createRequest) { try { r = W.createRequest(); } catch (e) { r=0; } }

	if (!r) {
		g_res.innerHTML = "<div><i>error, no xml http support</i></div>";
		return;
	}
	r.open("GET", list, true);
	r.onreadystatechange = function() {
		if (r.readyState == 4) {
			if (r.status == 200) {
				impD(r.responseText);
			} else {
				g_res.innerHTML = "<div><i>error, got " + r.status + " for " + list + " </i></div>";
			}
	
		}
	};
	g_res.innerHTML = "<div><i>fetching list of tracks...</i></div>";
	r.send(null);
}

function impD(text) {
        var x, ol = g_pl.length, ln = text.split("\n"), h=window.location.hash;
	for (x in ln) {
		var s = ln[x].split("\t");
		if (s.length >= 2) {
			if (s[0] == "pre") {
				if (g_pl_ipp) g_pl.push(s[1]);
			}
			else if (s[0] == "item") {
				g_db_lens.push(s.length > 2 ? s[2] : 0);
				g_db.push(s[1]);
			}
		}
	}
	if (!ol) { g_pl.length > 0 ? pPi(0,0) : g_pl_ipp=0; }
	genRes();
	plUpd();
	if ((x=h.replace(/^#pq=(.*)$/,"$1")) != h) {
		if (x == "") seek(0);
		else {
			getE("fbox").value=decodeURIComponent(x);
			plClr();
			pAll(1);
		}
		visb();
	}
}

function init() {
	g_play = getE("pctl");
	g_res = getE("res");
	repcl();

	window.onbeforeunload = function() { 
		return isStop() || g_play.paused ? null : 'WHUMP playback active'; 
	};

	W.setInterval(function() { 
		isStop() && seek(g_rep == 1 && g_pl_x >= g_pl.length-1 ? 0 : (g_pl_x+(g_rep!=2))); 
	}, 100);

	whump_init();
}

</script>
<script src="whump_config.js"></script>
</head>
<body onLoad="init();">
<div id="thdr"></div>
<div id="pcont">
	<div id="nowp">...</div> 
	<div id="nowb">
		<span class="btb" onClick="seek(g_pl_x-1)">&lt;&lt;</span> 
		<span class="btb" id="rep" onClick="repcl()"></span>
		<span class="btb" id="visb" onClick="visb()">vis</span>
		<span class="btb" onClick="seek(g_pl_x+1)">&gt;&gt;</span>
	</div>
	<audio controls="controls" id="pctl"></audio>
</div>
<canvas id="vis" onClick="g_vm++"></canvas>
<div id="lib">
	<div id="lcont">
		<div class="tbar">search: <input id="fbox" type="text" size=40 onkeyup="onF();"/>
			<span class="btn" onClick="pAll(0)">play all</span>
			<span class="btn" onClick="pAll(1)">queue all</span>
		</div>
		<div id="res"><div><i>initializing...</i></div></div>
	</div>
	<div id="rcont">
		<div class="tbar">playlist: 
			<span class="btn" onClick="plClr()">clear</span>
			<span class="btn" onClick="plSrt(0)">sort</span>
			<span class="btn" onClick="plSrt(1)">reverse</span>
			<span class="btn" onClick="plSrt(2)">randomize</span>
			<span class="btn" onClick="plSave()">save</span>
			<span class="btn" onClick="plLoad()">load</span>
			<span id="phn"></span>
		</div>
		<div id="pl"></div>
	</div>
</div>
<div id="foot"></div>
</body>
</html>
